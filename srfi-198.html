<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SRFI 198: Foreign Interface Error Handling</title>
    <link href="/favicon.png" rel="icon" sizes="192x192" type="image/png">
    <link rel="stylesheet" href="https://srfi.schemers.org//srfi.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1"></head>
  <body>
    <h1><a href="https://srfi.schemers.org/"><img class="srfi-logo" src="https://srfi.schemers.org/srfi-logo.svg" alt="SRFI logo" /></a>198: Foreign Interface Error Handling</h1>


<div>Authors</p>

<p>
John Cowan, Lassi Kortela, and Harold Ancell
</p>


<h2>Status</h2>


<h2>Abstract</h2>

<p>
When errors from Scheme interfaces to "foreign" systems such as the
P<small>OSIX</small> API, libraries, and databases are detected, this
SRFI provides the means to construct, return or signal, and extract
information from those errors in a reasonably uniform way.
</p>


<h2>Issues</h2>

<p>
None at present.
</p>


<h2>Rationale</h2>

<p>R6RS and R7RS-large have ambitions to become comprehensive
ecosystems useful for developing real world applications.  This
necessitates the development of many interfaces to "foreign" systems,
ranging from direct Foreign Function Interfaces (FFIs) to low level
assembler and C libraries, including APIs at that level such as
P<small>OSIX</small>, to protocols such as TCP/IP, all the way to
client-server systems such as databases running in their own
seperate processes.</p>

<p>This SRFI provides a comprehensive framework for placing data about
errors from foreign systems into an object, starting with
<em>error-sets</em> to partition collections of related errors,
such as 'posix, 'postgresql, and 'libsodium, and to report them.</p>

<p>Sometimes it will make sense to simply return an error object, but
an often preferred method is to raise an exception, like
<a href="https://srfi.schemers.org/srfi-170/srfi-170.html">SRFI
170</a> in which procedures never return error codes, nor use an
analogue of the P<small>OSIX</small> <code>errno</code> variable to
indicate system-call-level errors.</p>

<p>Thus procedures can return useful values, and the programmer can to
assume that if a foreign interface procedure returns, it succeeded.
This greatly simplifies the flow of the code from the programmer's
point of view.</p>


<h2>Specification</h2>

<h3>Procedures</h3> <!-- ~~~FIX_ME Remove if every item turns out to be a procedure -->

<h4>Error predicate</h4>

<div align="left">
<code>(foreign-error? <i>object</i>)</code> &nbsp;&nbsp;&nbsp;&rarr; &nbsp;&nbsp;&nbsp;<i>boolean</i> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
Returns #f unless <i>object</i> is a SRFI 198 error.
</p>
<pre class="example">
(foreign-error? "This is not an foreign error object") &rArr; #f
(foreign-error? (make-foreign-error &lt;valid-alist&gt;)) &rArr; #t
</pre>
</blockquote>

<h4>Error field getters</h4>

<p>
When an error set does not have a concept that corresponds to an error field, its value must be <code>#f</code>.
</p>

<br>

<div align="left">
<code>(foreign-error:error-set <i>foreign-error-object</i>)</code> &nbsp;&nbsp;&nbsp;&rarr; &nbsp;&nbsp;&nbsp;<i>symbol</i> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
Partitions the universe of foreign errors into distinct collections based on their source.
The set <code>'error</code> is reserved for generic errors, particularly sanity error checking before the foreign interface is invoked.
</p>
<pre class="example">
(foreign-error:error-set &lt;POSIX-foreign-error-object&gt;) &rArr; errno
</pre>

<p>
Example error sets include:
</p>

<table> <!-- ~~~FIX_ME formatting of table -->
<tr><th>'errno</th> <th><a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/errno.h.html">P<small>OSIX</small> errnos</a></th></tr>
<tr><th>'postgresql</th> <th><a href="https://www.postgresql.org/docs/current/errcodes-appendix.html">PostgreSQL errors</a></th></tr>
<tr><th>libsodium</th> <th><a href="https://doc.libsodium.org/">The libsodium cryptograpghy library</a></th></tr>
</table>
</blockquote>

<br>

<div align="left">
<code>(foreign-error:code <i>foreign-error-object</i>)</code> &nbsp;&nbsp;&nbsp; &rarr; &nbsp;&nbsp;&nbsp; <i>alist</i> or <code>#f</code> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
Many <em>error sets</em> are organized by simple "codes", such as numbers, short alphanumeric designations that should be represented as symbols, etc.  Each <i>error set</i> should have conventions for this.
</p>
<pre class="example">
(foreign-error:code &lt;POSIX-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; ((number . 2)
     (c-define . errno/ENOENT))
</pre>
<pre class="example">
(foreign-error:code &lt;PostgreSQL-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; ((class-number . 28)
     (class-title . "Invalid Authorization Specification")
     (code . 28P01)
     (condition-name . invalid_password))
</pre>
<pre class="example">
(foreign-error:code &lt;libsodium-foreign-error-object&gt;)
</pre>
<pre class="example">
 &rArr; #f
</pre>
</blockquote>

<br>

<div align="left">
<code>(foreign-error:scheme-procedure <i>foreign-error-object</i>)</code> &nbsp; &rarr; &nbsp; <i>symbol</i> or <code>#f</code> &nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
The Scheme procedure in which the error object is created.  If there
is no Scheme code interposed between the the user and a FFI, it can
be <code>#f</code>.  If the alist argument to create an error is
malformed, it should be <code>'make-foreign-error</code>.
</p>
<pre class="example">
(foreign-error:scheme-procedure &lt;P<small>OSIX</small>-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; open-file
</pre>
<pre class="example">
(foreign-error:scheme-procedure &lt;PostgreSQL-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; open-database-connection
</pre>
<pre class="example">
(foreign-error:scheme-procedure &lt;libsodium-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; generate-key
</pre>
</blockquote>

<br>

<div align="left">
<code>(foreign-error:foreign-interface <i>foreign-error-object</i>)</code> &nbsp; &rarr; &nbsp; <i>symbol</i> &nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
The specific part of the foreign interface that raised an error.  For a library, the name of the library function that was called would be appropriate.
</p>
<pre class="example">
(foreign-error:foreign-interface &lt;P<small>OSIX</small>-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; open
</pre>
<pre class="example">
(foreign-error:interface &lt;PostgreSQL-wire-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; query-message
</pre>
<pre class="example">
(foreign-error:foreign-interface &lt;libsodium-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; sodium_init
</pre>
</pre>
</blockquote>

<br>

<div align="left">
<code>(foreign-error:message <i>foreign-error-object</i>)</code> &nbsp; &rarr; &nbsp; <i>string</i> or <code>#f</code> &nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
A message suitable for human understanding of the error.
In the construction of the error message, implementers are encouraged
to include relevant information from the above fields, and the data
field below.
Implementations on small memory systems can reasonably omit message
strings.
</p>
<pre class="example">
(foreign-error:message &lt;P<small>OSIX</small>-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; "open-file called open: errno/ENOENT: No such file or directory"
</pre>
<pre class="example">
(foreign-error:message &lt;PostgreSQL-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; "open-database-connection: 28P01: incorrect password"
</pre>
<pre class="example">
(foreign-error:message &lt;ecb-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; "generate-key: ecb-generate-key could not initialize sodium library"
</pre>
</blockquote>

<br>

<div align="left">
<code>(foreign-error:data <i>foreign-error-object</i>)</code> &nbsp; &rarr; &nbsp; <i>alist</i> or <code>#f</code>&nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
Any additional data relevant to the error.  It is <em>strongly</em>
recommended this includes the <code>'arguments</code> handed to the
Scheme procedure.  Useful historical information can be transmitted
using the <code>'heritage</code> key.
</p>
<pre class="example">
(foreign-error:data &lt;P<small>OSIX</small>-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; ((arguments "not-a-valid-filename" 0 428))
     (heritage . "SRFI 170"))
</pre>
<pre class="example">
(foreign-error:data &lt;PostgreSQL-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; ((arguments "localhost" 5432 "ecb" "ecb")))
</pre>
<pre class="example">
(foreign-error:data &lt;libsodium-foreign-error-object&gt;)
</pre>
<pre class="example">
  &rArr; #f
</pre>
<p>
For login functions, you want to omit reporting and logging plaintext
passwords, and login names are also dangerous because users will
sometimes accidently enter their password first.
For cryptographic libraries, the same for secret and private keys, and
plaintext data.
</p>
</blockquote>


<h4>Error constructors</h4>

<div align="left">
<code>(make-foreign-error <i>alist</i>)</code> &nbsp; &rarr; &nbsp; <i>foreign-error-object</i> &nbsp;&nbsp;&nbsp;(procedure)
<div>
<div align="left">
<code>(raise-foreign-error <i>alist [continuable]</i>)</code> &nbsp; &rarr; &nbsp; <i>undefined</i> &nbsp;&nbsp;&nbsp;(procedure)
</div>
<blockquote>
<p>
These procedures are handed alists, the keys of the pairs being the
above getters after the colon, like <code>'error-set</code>,
and <code>'message</code>.
Only <code>'error-set</code> is required, omitted pairs will result in
the corresponing slots being set to <code>#f</code>.
</p>
<p>
<code>raise-foreign-error</code> takes the <i>foreign-error-object</i>
returned by <code>make-foreign-error</code> and raises an exception in
a manner suitable for the Scheme implementation it is running on.  Its
actions are at the complete discretion of that Scheme implementation's
community.
If the optional argument <code>continuable</code> is not the default
of <code>#f</code>, it will ideally raise a continuable exception.
</p>
<pre class="example">
(make-foreign-error '((error-set . error)))
</pre>
<pre class="example">
  &rArr; <i>error-set-object</i>
</pre>
<pre class="example">
(make-foreign-error '((error-set . errno)
                      (code .((number . 2)
                              (symbol . errno/ENOENT)))
                      (scheme-procedure . open-file)
                      (foreign-interface . open)
                      (message . "open-file called open: errno/ENOENT: No such file or directory")
                      (data . ((arguments . ("not-a-valid-filename" 0 428))
                               (heritage . "SRFI 170")))))
</pre>
<pre class="example">
  &rArr; <i>error-set-object</i>
</pre>
<pre class="example">
(make-foreign-error '((error-set . libsodium)
                      (scheme-procedure . generate-key)
                      (foreign-interface . sodium-init)
                      (message . "generate-key: ecb-generate-key could not initialize sodium library\n")))
</pre>
<pre class="example">
  &rArr;  <i>error-set-object</i>
</pre>
<pre class="example">
(raise-foreign-error '((error-set . error)))
</pre>
<pre class="example">
  &rArr; <i>undefined</i>
</pre>
<pre class="example">
(raise-foreign-error '((error-set . error)) #f)
</pre>
<pre class="example">
  &rArr; <i>undefined</i>, will ideally raise a continuable exception.
</pre>
</blockquote>


<h2>Implementation</h2>

<p>
A Chibi Scheme sample implementation of this SRFI can be found in the
srfi directory of the SRFI's repository.
</p>


<h2>Acknowledgments</h2>

<p>
Thanks to Olin Shivers and all the Scheme implementers who have
followed his work; this SRFI was inspired by scsh's
<code>errno-error</code> facility.  Thanks also to all the
participants in the SRFI 170 and SRFI 198 mailing lists.
</p>

<h2>Copyright</h2>
<p>Copyright &copy; 2020 John Cowan, Lassi Kortela, and Harold Ancell</p>

<p>
  Permission is hereby granted, free of charge, to any person
  obtaining a copy of this software and associated documentation files
  (the "Software"), to deal in the Software without restriction,
  including without limitation the rights to use, copy, modify, merge,
  publish, distribute, sublicense, and/or sell copies of the Software,
  and to permit persons to whom the Software is furnished to do so,
  subject to the following conditions:</p>

<p>
  The above copyright notice and this permission notice (including the
  next paragraph) shall be included in all copies or substantial
  portions of the Software.</p>
<p>
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
  NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
  BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
  ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
  CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.</p>

  <hr>
  <address>Editor: <a href="mailto:srfi-editors+at+srfi+dot+schemers+dot+org">Arthur A. Gleckler</a></address></body></html>
